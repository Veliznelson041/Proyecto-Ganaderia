{% extends 'app_sigrams/base.html' %}

{% block title %}{{ titulo }} - SIGRAMS{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2 text-catamarca">{{ titulo }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'lista_marcas' %}" class="btn btn-outline-secondary">
            ‚Üê Volver a la lista
        </a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="post" enctype="multipart/form-data" id="marcaForm">
            {% csrf_token %}
            
            <div class="row">
                <div class="col-md-6">
                    <h5 class="text-catamarca mb-3">Datos B√°sicos</h5>
                    
                    <div class="mb-3">
                        <label for="{{ form.productor.id_for_label }}" class="form-label">Productor *</label>
                        {{ form.productor }}
                        {% if form.productor.errors %}
                            <div class="text-danger small">{{ form.productor.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.campo.id_for_label }}" class="form-label">Campo *</label>
                        {{ form.campo }}
                        {% if form.campo.errors %}
                        <div class="text-danger small">{{ form.campo.errors }}</div>
                        {% endif %}
                        <div class="form-text" id="campo-help-text">
                            Selecciona primero un productor para ver sus campos
                        </div>
                        <div class="alert alert-info mt-2" id="creando-campo" style="display: none;">
                            <small><i class="fas fa-spinner fa-spin"></i> Creando campo autom√°ticamente...</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.tipo_tramite.id_for_label }}" class="form-label">Tipo de Tr√°mite *</label>
                            {{ form.tipo_tramite }}
                            {% if form.tipo_tramite.errors %}
                                <div class="text-danger small">{{ form.tipo_tramite.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.numero_orden.id_for_label }}" class="form-label">N√∫mero de Orden *</label>
                            {{ form.numero_orden }}
                            {% if form.numero_orden.errors %}
                                <div class="text-danger small">{{ form.numero_orden.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.fecha_inscripcion.id_for_label }}" class="form-label">Fecha de Inscripci√≥n *</label>
                            {{ form.fecha_inscripcion }}
                            {% if form.fecha_inscripcion.errors %}
                                <div class="text-danger small">{{ form.fecha_inscripcion.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.fecha_vencimiento.id_for_label }}" class="form-label">Fecha de Vencimiento</label>
                            {{ form.fecha_vencimiento }}
                            {% if form.fecha_vencimiento.errors %}
                                <div class="text-danger small">{{ form.fecha_vencimiento.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.estado.id_for_label }}" class="form-label">Estado *</label>
                        {{ form.estado }}
                        {% if form.estado.errors %}
                            <div class="text-danger small">{{ form.estado.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-6">
                    <h5 class="text-catamarca mb-3">Marcas y Se√±ales</h5>

                    <!-- Galer√≠a de im√°genes predefinidas -->
                    <div class="mb-3">
                        <label class="form-label">Seleccionar Marca Predefinida</label>
                        <div class="row g-2" id="galeria-marcas">
                            {% for imagen in imagenes_predefinidas %}
                            <div class="col-4 col-sm-3">
                                <div class="card marca-predefinida" data-imagen-id="{{ imagen.id }}" data-imagen-url="{{ imagen.imagen.url }}">
                                    <img src="{{ imagen.imagen.url }}" class="card-img-top" alt="{{ imagen.nombre }}" style="height: 80px; object-fit: cover;">
                                    <div class="card-body p-2">
                                        <small class="card-text">{{ imagen.nombre }}</small>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="col-12">
                                <p class="text-muted">No hay im√°genes predefinidas cargadas.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Vista previa de imagen seleccionada -->
                    <div id="imagen-seleccionada-container" class="mb-3" style="display: none;">
                            <label class="form-label">Imagen Seleccionada:</label>
                        <div class="card">
                            <div class="card-body text-center">
                                <img id="imagen-seleccionada-preview" src="" alt="Imagen seleccionada" 
                                     class="img-fluid mb-2" style="max-height: 150px;">
                                <p id="imagen-seleccionada-nombre" class="mb-0"></p>
                                <button type="button" class="btn btn-sm btn-outline-danger mt-2" 
                                        onclick="deseleccionarImagen()">
                                    Quitar selecci√≥n
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.descripcion_marca.id_for_label }}" class="form-label">Descripci√≥n de la Marca *</label>
                        {{ form.descripcion_marca }}
                        {% if form.descripcion_marca.errors %}
                            <div class="text-danger small">{{ form.descripcion_marca.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.imagen_marca.id_for_label }}" class="form-label">Imagen de la Marca (se llena autom√°ticamente al seleccionar arriba)</label>
                        {{ form.imagen_marca }}
                        {% if form.imagen_marca.errors %}
                            <div class="text-danger small">{{ form.imagen_marca.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.tipo_senal.id_for_label }}" class="form-label">Tipo de Se√±al</label>
                        {{ form.tipo_senal }}
                        {% if form.tipo_senal.errors %}
                            <div class="text-danger small">{{ form.tipo_senal.errors }}</div>
                        {% endif %}
                        {% if not form.tipo_senal.field.queryset.exists %}
                        <div class="alert alert-warning mt-2">
                            <small>No hay tipos de se√±ales configurados. <a href="/admin/app_registros/tiposenal/add/" target="_blank">Agregar tipos de se√±ales</a></small>
                        </div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.descripcion_senal.id_for_label }}" class="form-label">Descripci√≥n de la Se√±al</label>
                        {{ form.descripcion_senal }}
                        {% if form.descripcion_senal.errors %}
                            <div class="text-danger small">{{ form.descripcion_senal.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    <h5 class="text-catamarca mb-3">Inventario de Ganado</h5>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="{{ form.vacuno.id_for_label }}" class="form-label">Vacuno</label>
                    {{ form.vacuno }}
                </div>
                <div class="col-md-2 mb-3">
                    <label for="{{ form.caballar.id_for_label }}" class="form-label">Caballar</label>
                    {{ form.caballar }}
                </div>
                <div class="col-md-2 mb-3">
                    <label for="{{ form.mular.id_for_label }}" class="form-label">Mular</label>
                    {{ form.mular }}
                </div>
                <div class="col-md-2 mb-3">
                    <label for="{{ form.asnal.id_for_label }}" class="form-label">Asnal</label>
                    {{ form.asnal }}
                </div>
                <div class="col-md-2 mb-3">
                    <label for="{{ form.ovino.id_for_label }}" class="form-label">Ovino</label>
                    {{ form.ovino }}
                </div>
                <div class="col-md-2 mb-3">
                    <label for="{{ form.cabrio.id_for_label }}" class="form-label">Cabrio</label>
                    {{ form.cabrio }}
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <h5 class="text-catamarca mb-3">Informaci√≥n Administrativa</h5>

                    <div class="mb-3">
                        <label for="{{ form.valor_sellado.id_for_label }}" class="form-label">Valor del Sellado</label>
                        {{ form.valor_sellado }}
                        {% if form.valor_sellado.errors %}
                            <div class="text-danger small">{{ form.valor_sellado.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.observaciones.id_for_label }}" class="form-label">Observaciones</label>
                        {{ form.observaciones }}
                        {% if form.observaciones.errors %}
                            <div class="text-danger small">{{ form.observaciones.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-6">
                    <h5 class="text-catamarca mb-3">Carnet</h5>

                    <div class="mb-3">
                        <label for="{{ form.imagen_carnet_frente.id_for_label }}" class="form-label">Imagen Carnet Frente</label>
                        {{ form.imagen_carnet_frente }}
                        {% if form.imagen_carnet_frente.errors %}
                            <div class="text-danger small">{{ form.imagen_carnet_frente.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.imagen_carnet_dorso.id_for_label }}" class="form-label">Imagen Carnet Dorso</label>
                        {{ form.imagen_carnet_dorso }}
                        {% if form.imagen_carnet_dorso.errors %}
                            <div class="text-danger small">{{ form.imagen_carnet_dorso.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-catamarca me-2">
                    üíæ Guardar Marca/Se√±al
                </button>
                <a href="{% url 'lista_marcas' %}" class="btn btn-outline-secondary">
                    Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Template para opciones de campo -->
<template id="campoOptionsTemplate">
    <option value="">---------</option>
</template>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const productorSelect = document.getElementById('id_productor');
    const campoSelect = document.getElementById('id_campo');
    const campoHelpText = document.getElementById('campo-help-text');
    const creandoCampoAlert = document.getElementById('creando-campo');

    // ==============================
    // CARGA DIN√ÅMICA DE CAMPOS
    // ==============================
    if (productorSelect && campoSelect) {
        productorSelect.addEventListener('change', function() {
            const productorId = this.value;

            if (!productorId) {
                campoSelect.innerHTML = '<option value="">Seleccione un productor primero</option>';
                campoSelect.disabled = true;
                if (campoHelpText) {
                    campoHelpText.textContent = 'Selecciona primero un productor para ver sus campos';
                }
                return;
            }

            // Loading
            campoSelect.innerHTML = '<option value="">Cargando campos...</option>';
            campoSelect.disabled = true;
            if (campoHelpText) {
                campoHelpText.textContent = 'Cargando campos...';
            }
            if (creandoCampoAlert) {
                creandoCampoAlert.style.display = 'none';
            }

            fetch(`/ajax/campos/${productorId}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    return response.json();
                })
                .then(data => {
                    campoSelect.innerHTML = '<option value="">---------</option>';

                    if (!data || data.length === 0) {
                        campoSelect.innerHTML = '<option value="">No hay campos registrados</option>';
                        if (campoHelpText) {
                            campoHelpText.textContent = 'No hay campos registrados para este productor';
                        }
                        campoSelect.disabled = true;
                        return;
                    }

                    data.forEach(campo => {
                        if (campo.error) {
                            throw new Error(campo.error);
                        }

                        const option = document.createElement('option');
                        option.value = campo.id;
                        option.textContent = campo.distrito
                            ? `${campo.nombre} (${campo.distrito})`
                            : campo.nombre;
                        campoSelect.appendChild(option);
                    });

                    campoSelect.disabled = false;
                    if (campoHelpText) {
                        campoHelpText.textContent = `Se encontraron ${data.length} campo(s)`;
                    }

                    // Si hay uno solo ‚Üí autoseleccionar
                    if (data.length === 1) {
                        campoSelect.value = data[0].id;

                        if (data[0].creado_automaticamente && creandoCampoAlert) {
                            creandoCampoAlert.innerHTML =
                                '<small><i class="fas fa-check"></i> Campo creado autom√°ticamente basado en los datos del productor</small>';
                            creandoCampoAlert.className = 'alert alert-success mt-2';
                            creandoCampoAlert.style.display = 'block';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    campoSelect.innerHTML = '<option value="">Error al cargar campos</option>';
                    campoSelect.disabled = false;
                    if (campoHelpText) {
                        campoHelpText.textContent = `Error: ${error.message}`;
                    }
                });
        });

        // Para edici√≥n
        if (productorSelect.value) {
            productorSelect.dispatchEvent(new Event('change'));
        }
    }

    // ==============================
    // IM√ÅGENES PREDEFINIDAS
    // ==============================
    cargarImagenesPredefinidas();
});

// ==============================
// GALER√çA DE IM√ÅGENES
// ==============================
function cargarImagenesPredefinidas() {
    const galeriaMarcas = document.getElementById('galeria-marcas');
    if (!galeriaMarcas) return;

    fetch('/ajax/imagenes-marcas/')
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al cargar im√°genes');
            }
            return response.json();
        })
        .then(data => {
            if (data && data.length > 0) {
                galeriaMarcas.innerHTML = '';
                data.forEach(imagen => {
                    const col = document.createElement('div');
                    col.className = 'col-4 col-sm-3 mb-2';
                    col.innerHTML = `
                        <div class="card marca-predefinida h-100"
                             onclick="seleccionarImagenMarca(this, ${imagen.id}, '${imagen.nombre.replace(/'/g, "\\'")}', '${imagen.imagen_url || imagen.imagen}')"
                             style="cursor: pointer;">
                            <img src="${imagen.imagen_url || imagen.imagen}"
                                 class="card-img-top"
                                 alt="${imagen.nombre}"
                                 style="height: 80px; object-fit: cover;">
                            <div class="card-body p-1 text-center">
                                <small class="card-text d-block">${imagen.nombre}</small>
                                <small class="text-muted">${imagen.tipo_marca}</small>
                            </div>
                        </div>
                    `;
                    galeriaMarcas.appendChild(col);
                });
            } else {
                galeriaMarcas.innerHTML =
                    '<div class="col-12"><p class="text-muted">No hay im√°genes predefinidas cargadas.</p></div>';
            }
        })
        .catch(error => {
            console.error('Error cargando im√°genes:', error);
            galeriaMarcas.innerHTML =
                '<div class="col-12"><p class="text-muted">Error al cargar im√°genes</p></div>';
        });
}

// ==============================
// SELECCI√ìN DE IMAGEN
// ==============================
function seleccionarImagenMarca(elemento, imagenId, nombreMarca, imagenUrl) {
    document.querySelectorAll('.marca-predefinida').forEach(card => {
        card.classList.remove('selected', 'border-primary', 'border-2');
        card.classList.add('border-light');
    });

    elemento.classList.remove('border-light');
    elemento.classList.add('selected', 'border-primary', 'border-2');

    let hiddenInput = document.getElementById('imagen_predefinida_id');
    if (!hiddenInput) {
        hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'imagen_predefinida_id';
        hiddenInput.id = 'imagen_predefinida_id';
        document.querySelector('form').appendChild(hiddenInput);
    }
    hiddenInput.value = imagenId;

    mostrarImagenSeleccionada(imagenUrl, nombreMarca);
}

// ==============================
// PREVIEW IMAGEN SELECCIONADA
// ==============================
function mostrarImagenSeleccionada(imagenUrl, nombre) {
    const container = document.getElementById('imagen-seleccionada-container');
    const preview = document.getElementById('imagen-seleccionada-preview');
    const nombreElem = document.getElementById('imagen-seleccionada-nombre');

    if (!container || !preview || !nombreElem) return;

    if (imagenUrl) {
        preview.src = imagenUrl;
        nombreElem.textContent = nombre;
        container.style.display = 'block';
    } else {
        container.style.display = 'none';
    }
}

// ==============================
// DESELECCIONAR IMAGEN
// ==============================
function deseleccionarImagen() {
    document.querySelectorAll('.marca-predefinida').forEach(card => {
        card.classList.remove('selected', 'border-primary', 'border-2');
        card.classList.add('border-light');
    });

    const hiddenInput = document.getElementById('imagen_predefinida_id');
    if (hiddenInput) hiddenInput.value = '';

    mostrarImagenSeleccionada(null, null);
}
</script>


<style>
.marca-predefinida {
    cursor: pointer;
    transition: transform 0.2s;
    border: 2px solid #dee2e6;
}

.marca-predefinida:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.marca-predefinida.selected {
    border-color: #0A2E5A !important;
    background-color: rgba(10, 46, 90, 0.05);
}

.form-control:required {
    border-left: 3px solid #0A2E5A;
}

.small-input {
    max-width: 100px;
}

/* Mejora para selects */
select.form-control {
    cursor: pointer;
}

/* Estado de loading para campos */
select:disabled {
    background-color: #e9ecef;
    cursor: not-allowed;
}
</style>
{% endblock %}