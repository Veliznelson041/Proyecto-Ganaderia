{% extends 'app_sigrams/base.html' %}

{% block title %}Dashboard - SIGRAMS{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2 text-catamarca">
        <i class="fas fa-tachometer-alt"></i> Dashboard Principal
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <span class="btn btn-sm btn-outline-catamarca disabled">
                <i class="fas fa-calendar"></i> {{ hoy|date:"d/m/Y" }}
            </span>
        </div>
    </div>
</div>

<!-- Tarjetas de estadísticas principales -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start-catamarca border-start-3 shadow h-100">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs fw-bold text-catamarca text-uppercase mb-1">
                            Productores Registrados
                        </div>
                        <div class="h5 mb-0 fw-bold text-gray-800">{{ total_productores }}</div>
                        <div class="mt-2 mb-0 text-muted text-xs">
                            <span class="text-success mr-2">
                                <i class="fas fa-user-plus"></i> +{{ productores_recientes|length }} nuevos
                            </span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x text-catamarca opacity-50"></i>
                    </div>
                </div>
                <a href="{% url 'lista_productores' %}" class="btn btn-sm btn-catamarca mt-3 w-100">
                    <i class="fas fa-list"></i> Ver todos
                </a>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start-success border-start-3 shadow h-100">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs fw-bold text-success text-uppercase mb-1">
                            Marcas Activas
                        </div>
                        <div class="h5 mb-0 fw-bold text-gray-800">{{ total_marcas }}</div>
                        <div class="mt-2 mb-0 text-muted text-xs">
                            <span class="text-warning mr-2">
                                <i class="fas fa-clock"></i> {{ marcas_por_vencer|length }} por vencer
                            </span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-tag fa-2x text-success opacity-50"></i>
                    </div>
                </div>
                <a href="{% url 'lista_marcas' %}" class="btn btn-sm btn-success mt-3 w-100">
                    <i class="fas fa-tags"></i> Gestionar
                </a>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start-warning border-start-3 shadow h-100">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs fw-bold text-warning text-uppercase mb-1">
                            Solicitudes Pendientes
                        </div>
                        <div class="h5 mb-0 fw-bold text-gray-800">{{ solicitudes_pendientes }}</div>
                        <div class="mt-2 mb-0 text-muted text-xs">
                            <span class="text-info mr-2">
                                <i class="fas fa-chart-line"></i> {{ tramites_mes }} este mes
                            </span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clipboard-list fa-2x text-warning opacity-50"></i>
                    </div>
                </div>
                <a href="{% url 'lista_solicitudes' %}" class="btn btn-sm btn-warning mt-3 w-100">
                    <i class="fas fa-tasks"></i> Revisar
                </a>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start-info border-start-3 shadow h-100">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs fw-bold text-info text-uppercase mb-1">
                            Ingresos del Mes
                        </div>
                        <div class="h5 mb-0 fw-bold text-gray-800">${{ ingresos_mes|floatformat:2 }}</div>
                        <div class="mt-2 mb-0 text-muted text-xs">
                            <span class="text-success mr-2">
                                <i class="fas fa-dollar-sign"></i> Sellados
                            </span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-chart-bar fa-2x text-info opacity-50"></i>
                    </div>
                </div>
                <button class="btn btn-sm btn-info mt-3 w-100" onclick="alert('Reporte de ingresos en desarrollo')">
                    <i class="fas fa-file-invoice-dollar"></i> Reporte
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Acciones rápidas y alertas -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card shadow mb-4">
            <div class="card-header bg-catamarca text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-bolt"></i> Acciones Rápidas
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <a href="{% url 'nuevo_productor' %}" class="btn btn-catamarca w-100 h-100 py-3">
                            <i class="fas fa-user-plus fa-2x mb-2"></i><br>
                            Nuevo Productor
                        </a>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <a href="{% url 'nueva_marca' %}" class="btn btn-success w-100 h-100 py-3">
                            <i class="fas fa-tag fa-2x mb-2"></i><br>
                            Nueva Marca
                        </a>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <a href="{% url 'nueva_solicitud' %}" class="btn btn-warning w-100 h-100 py-3">
                            <i class="fas fa-file-alt fa-2x mb-2"></i><br>
                            Nueva Solicitud
                        </a>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <a href="/admin/" target="_blank" class="btn btn-info w-100 h-100 py-3">
                            <i class="fas fa-cogs fa-2x mb-2"></i><br>
                            Panel Admin
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card shadow border-warning">
            <div class="card-header bg-warning text-dark py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-exclamation-triangle"></i> Alertas Importantes
                </h6>
            </div>
            <div class="card-body">
                {% if marcas_por_vencer %}
                    <div class="alert alert-warning mb-2">
                        <strong><i class="fas fa-clock"></i> Marcas por vencer:</strong>
                        <br>
                        <small>
                            {% for marca in marcas_por_vencer %}
                                • #{{ marca.numero_orden }} - {{ marca.productor.nombre_completo }}<br>
                                <span class="text-muted">Vence: {{ marca.fecha_vencimiento|date:"d/m/Y" }}</span><br>
                            {% endfor %}
                        </small>
                    </div>
                {% else %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> No hay marcas próximas a vencer
                    </div>
                {% endif %}
                
                {% if solicitudes_pendientes > 0 %}
                    <div class="alert alert-info">
                        <i class="fas fa-inbox"></i> 
                        <strong>{{ solicitudes_pendientes }} solicitudes pendientes</strong>
                        <a href="{% url 'lista_solicitudes' %}" class="btn btn-sm btn-outline-info float-end">
                            Revisar
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Sección de actividad reciente -->
<div class="row">
    <!-- Últimas solicitudes -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header bg-catamarca text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-history"></i> Últimas Solicitudes
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>ID</th>
                                <th>Productor</th>
                                <th>Trámite</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for solicitud in ultimas_solicitudes %}
                            <tr style="cursor: pointer;" onclick="window.location='#'">
                                <td><strong>#{{ solicitud.id }}</strong></td>
                                <td>{{ solicitud.productor.nombre_completo|truncatechars:20 }}</td>
                                <td>
                                    <span class="badge bg-info">{{ solicitud.get_tipo_tramite_display|truncatechars:15 }}</span>
                                </td>
                                <td>
                                    <span class="badge {% if solicitud.estado == 'PENDIENTE' %}bg-warning
                                                    {% elif solicitud.estado == 'APROBADO' %}bg-success
                                                    {% else %}bg-danger{% endif %}">
                                        {{ solicitud.get_estado_display }}
                                    </span>
                                </td>
                                <td>{{ solicitud.fecha_solicitud|date:"d/m" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-3 text-muted">
                                    <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                    No hay solicitudes recientes
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer text-center">
                    <a href="{% url 'lista_solicitudes' %}" class="btn btn-sm btn-catamarca">
                        <i class="fas fa-external-link-alt"></i> Ver todas las solicitudes
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Productores recientes -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header bg-success text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-user-plus"></i> Productores Recientes
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>Nombre</th>
                                <th>DNI</th>
                                <th>Localidad</th>
                                <th>Estado</th>
                                <th>Registro</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for productor in productores_recientes %}
                            <tr style="cursor: pointer;" onclick="window.location='{% url 'detalle_productor' productor.id %}'">
                                <td>
                                    <strong>{{ productor.nombre_completo|truncatechars:20 }}</strong>
                                </td>
                                <td>{{ productor.dni }}</td>
                                <td>{{ productor.localidad|truncatechars:15 }}</td>
                                <td>
                                    <span class="badge {% if productor.estado == 'REGISTRADO' %}bg-success
                                                    {% elif productor.estado == 'PENDIENTE' %}bg-warning
                                                    {% else %}bg-info{% endif %}">
                                        {{ productor.get_estado_display }}
                                    </span>
                                </td>
                                <td>{{ productor.fecha_registro|date:"d/m" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-3 text-muted">
                                    <i class="fas fa-users fa-2x mb-2"></i><br>
                                    No hay productores recientes
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer text-center">
                    <a href="{% url 'lista_productores' %}" class="btn btn-sm btn-success">
                        <i class="fas fa-external-link-alt"></i> Ver todos los productores
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Distribuciones -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header bg-info text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-chart-pie"></i> Productores por Estado
                </h6>
            </div>
            <div class="card-body">
                {% for estado in productores_estados_list %}
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>{{ estado.estado }}</span>
                        <span class="fw-bold">{{ estado.total }}</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        {% with total=total_productores %}
                        {% if total > 0 %}
                        {% load math_filters %}
                        <div class="progress-bar bg-info" role="progressbar" 
                            style="width: {{ estado.total|div:total_productores|mul:100|floatformat:0 }}%">
                        </div>
                        {% endif %}
                        {% endwith %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-chart-bar"></i> Marcas por Tipo de Trámite
                </h6>
            </div>
            <div class="card-body">
                {% for tipo in marcas_tipos_list %}
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>{{ tipo.tipo_tramite }}</span>
                        <span class="fw-bold">{{ tipo.total }}</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        {% with total=total_marcas %}
                        {% if total > 0 %}
                        <div class="progress-bar bg-primary" role="progressbar" 
                             style="width: {{ tipo.total|floatformat:0|add:'0'|div:total|mul:100 }}%">
                        </div>
                        {% endif %}
                        {% endwith %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header bg-warning text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-chart-line"></i> Actividad del Sistema
                </h6>
            </div>
            <div class="card-body text-center">
                <div class="row">
                    <div class="col-6">
                        <div class="border rounded p-3 mb-3 bg-light">
                            <i class="fas fa-tag fa-2x text-success mb-2"></i>
                            <h4>{{ total_marcas }}</h4>
                            <small class="text-muted">Marcas Totales</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-3 mb-3 bg-light">
                            <i class="fas fa-file-alt fa-2x text-info mb-2"></i>
                            <h4>{{ tramites_mes }}</h4>
                            <small class="text-muted">Trámites Mes</small>
                        </div>
                    </div>
                </div>
                <div class="mt-2">
                    <span class="badge bg-catamarca">
                        <i class="fas fa-sync-alt"></i> Sistema actualizado
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    border-radius: 10px;
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-2px);
}

.border-start-catamarca {
    border-left-color: #0A2E5A !important;
}

.progress {
    border-radius: 10px;
    background-color: #f0f0f0;
}

.badge {
    font-size: 0.75em;
    padding: 0.35em 0.65em;
}

.table tbody tr:hover {
    background-color: rgba(10, 46, 90, 0.05);
}

.btn {
    border-radius: 8px;
    transition: all 0.3s;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>

<script>
// Actualizar la fecha y hora cada minuto
function actualizarHora() {
    const ahora = new Date();
    const opciones = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    };
    const fechaStr = ahora.toLocaleDateString('es-AR', opciones);
    document.querySelector('.btn-outline-catamarca.disabled').innerHTML = 
        `<i class="fas fa-calendar"></i> ${fechaStr}`;
}

// Actualizar cada minuto
setInterval(actualizarHora, 60000);

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    actualizarHora();
    
    // Agregar tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}